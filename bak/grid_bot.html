<!DOCTYPE html>
<html>
<head>
    <title>网格策略控制台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #000; color: #ccc; padding: 20px; font-family: monospace; font-size: 13px; }
        .card { background: #111; border: 1px solid #333; margin-bottom: 15px; }
        .card-header { border-bottom: 1px solid #333; color: #888; font-weight: bold; }
        .form-control, .form-select { background: #222; border: 1px solid #444; color: #fff; font-size: 12px; }
        .btn-primary { background-color: #238636; border: none; }
        .btn-danger { background-color: #da3633; border: none; }
        .grid-wall { height: 600px; overflow-y: auto; background: #050505; }
        .grid-row { display: flex; justify-content: space-between; padding: 4px 10px; border-bottom: 1px solid #222; }
        .text-up { color: #2ea043; }
        .text-down { color: #f85149; }
        .log-box { height: 200px; overflow-y: auto; color: #888; border-top: 1px solid #333; padding: 10px; }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">参数设置</div>
                <div class="card-body">
                    <form id="configForm">
                        <div class="mb-2">
                            <label>交易所</label>
                            <select class="form-select" name="exchange_id">
                                <option value="binance">Binance (币安)</option>
                                <option value="okx">OKX (欧易)</option>
                            </select>
                        </div>

                        <div class="mb-2">
                            <label>交易对</label>
                            <select class="form-select" name="symbol">
                                <option value="BTC/USDT">BTC/USDT</option>
                                <option value="ETH/USDT">ETH/USDT</option>
                                <option value="SOL/USDT">SOL/USDT</option>
                            </select>
                        </div>
                        <div class="mb-2"><input class="form-control" name="api_key" placeholder="API Key"></div>
                        <div class="mb-2"><input class="form-control" name="secret" type="password" placeholder="Secret Key"></div>
                        <div class="row g-1 mb-2">
                            <div class="col"><input class="form-control" name="lower_price" type="number" placeholder="下限" value="80000"></div>
                            <div class="col"><input class="form-control" name="upper_price" type="number" placeholder="上限" value="100000"></div>
                        </div>
                        <div class="row g-1 mb-3">
                            <div class="col"><input class="form-control" name="grid_num" type="number" placeholder="格数" value="20"></div>
                            <div class="col"><input class="form-control" name="amount" type="number" placeholder="数量" value="0.001"></div>
                        </div>
                        <button type="button" class="btn btn-primary w-100 mb-2" onclick="start()">启动策略</button>
                        <button type="button" class="btn btn-danger w-100" onclick="stop()">停止</button>
                    </form>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">收益监控</div>
                <div class="card-body text-center">
                    <h2 class="text-success" id="profit">0.0000</h2>
                    <div class="text-muted">当前价格: <span id="cur-price" class="text-white">---</span></div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span>挂单墙</span>
                    <span id="status-badge" class="badge bg-secondary">未运行</span>
                </div>
                <div class="grid-wall" id="grid-wall"></div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-header">策略日志</div>
                <div class="log-box h-100" id="logs"></div>
            </div>
        </div>
    </div>
</div>

<script>
    function start() {
        const data = Object.fromEntries(new FormData(document.getElementById('configForm')));
        fetch('/api/grid/start', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)})
        .then(r=>r.json()).then(res => { if(res.status!=='ok') alert(res.msg); });
    }
    function stop() { fetch('/api/grid/stop', {method:'POST'}); }

    setInterval(() => {
        fetch('/api/grid/status').then(r=>r.json()).then(d => {
            document.getElementById('profit').innerText = d.profit.toFixed(4);
            document.getElementById('cur-price').innerText = d.current_price;
            
            const badge = document.getElementById('status-badge');
            if(d.running) { badge.className='badge bg-success'; badge.innerText='运行中'; }
            else { badge.className='badge bg-secondary'; badge.innerText='未运行'; }

            if (d.orders && d.orders.length) {
                const html = d.orders.map(o => `
                    <div class="grid-row ${o.style}">
                        <span style="width:10%">#${o.idx}</span>
                        <span style="width:30%">${o.price}</span>
                        <span style="width:20%">${o.type}</span>
                        <span style="width:20%">${o.amt}</span>
                    </div>`).join('');
                document.getElementById('grid-wall').innerHTML = html;
            }

            if (d.logs && d.logs.length) {
                document.getElementById('logs').innerHTML = d.logs.map(l => `<div>${l}</div>`).join('');
            }
        });
    }, 1500);
</script>
</body>
</html>